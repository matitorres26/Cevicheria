{% extends "base.html" %}
{% block title %}Tu pedido{% endblock %}
{% block content %}

<h1 class="h4 mb-3">Tu pedido</h1>

<!-- Carrito -->
<div id="cart"></div>
<hr class="my-3">

<!-- Formulario -->
<form id="f" class="card card-body">
  {% csrf_token %}
  <div class="row">
    <div class="col-md-6 mb-2">
      <label class="form-label">Nombre</label>
      <input class="form-control" name="name" required>
    </div>
    <div class="col-md-6 mb-2">
      <label class="form-label">TelÃ©fono</label>
      <input class="form-control" name="phone">
    </div>
  </div>
  <div class="mb-2">
    <label class="form-label">DirecciÃ³n</label>
    <input class="form-control" name="address">
  </div>
  <div class="mb-2">
    <label class="form-label">Email</label>
    <input type="email" class="form-control" name="email">
  </div>
  <div class="mb-3">
    <label class="form-label">Pago</label>
    <select class="form-select" name="payment_method">
      <option value="CASH">Pagar en local / efectivo</option>
      <option value="WEBPAY">Webpay (pronto)</option>
      <option value="MERCADOPAGO">MercadoPago (pronto)</option>
    </select>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-success" id="btn-submit" type="submit">Enviar pedido</button>
    <button class="btn btn-outline-danger" id="btn-clear" type="button">Vaciar carrito</button>
  </div>

  <div id="msg" class="mt-3"></div>
</form>

<script>
// ---------- Estado / helpers ----------
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

function saveCart() {
  localStorage.setItem('cart', JSON.stringify(cart));
}

function money(n) {
  // muestra enteros con dos decimales
  const num = Number(n || 0);
  return '$' + num.toFixed(2);
}

// ---------- Render del carrito ----------
function renderCart() {
  const wrap = document.getElementById('cart');
  if (!cart.length) {
    wrap.innerHTML = '<div class="alert alert-warning">Tu carrito estÃ¡ vacÃ­o. Agrega productos desde el <a href="/menu/">menÃº</a>.</div>';
    document.getElementById('btn-submit').disabled = true;
    return;
  }
  document.getElementById('btn-submit').disabled = false;

  let total = 0;
  const rows = cart.map((item, idx) => {
    const subtotal = Number(item.qty) * Number(item.unit_price);
    item.subtotal = subtotal; // mantener consistente
    total += subtotal;
    return `
      <tr>
        <td>${item.product_name}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-secondary" data-act="dec" data-idx="${idx}">âˆ’</button>
          <span class="mx-2">${item.qty}</span>
          <button class="btn btn-sm btn-outline-secondary" data-act="inc" data-idx="${idx}">+</button>
        </td>
        <td class="text-end">${money(item.unit_price)}</td>
        <td class="text-end fw-semibold">${money(subtotal)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" data-act="del" data-idx="${idx}">Eliminar</button>
        </td>
      </tr>`;
  }).join('');

  wrap.innerHTML = `
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="width:160px">Cantidad</th>
            <th class="text-end">Precio</th>
            <th class="text-end">Subtotal</th>
            <th class="text-end">AcciÃ³n</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Total:</th>
            <th class="text-end h5">${money(total)}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  `;

  // DelegaciÃ³n de eventos para inc/dec/del
  wrap.querySelectorAll('button[data-act]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const act = e.currentTarget.dataset.act;
      const i = Number(e.currentTarget.dataset.idx);
      if (act === 'inc') cart[i].qty += 1;
      if (act === 'dec') cart[i].qty = Math.max(1, cart[i].qty - 1);
      if (act === 'del') cart.splice(i, 1);
      saveCart();
      renderCart();
    });
  });
}

renderCart();

// ---------- Vaciar carrito ----------
document.getElementById('btn-clear').addEventListener('click', () => {
  if (!cart.length) return;
  if (confirm('Â¿Vaciar carrito?')) {
    cart = [];
    saveCart();
    renderCart();
  }
});

// ---------- EnvÃ­o del pedido ----------
document.getElementById('f').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const out = document.getElementById('msg');

  if (!cart.length) {
    out.innerHTML = '<div class="alert alert-warning">Tu carrito estÃ¡ vacÃ­o.</div>';
    return;
  }

  const fd = new FormData(e.target);
  const csrftoken = fd.get('csrfmiddlewaretoken');

  // construir payload
  const items = cart.map(i => ({
    product_name: i.product_name,
    qty: Number(i.qty),
    unit_price: Number(i.unit_price),
    subtotal: Number(i.qty) * Number(i.unit_price)
  }));

  const body = {
    name: fd.get('name'),
    phone: fd.get('phone') || '',
    address: fd.get('address') || '',
    email: fd.get('email') || '',
    payment_method: fd.get('payment_method'),
    items
  };

  // enviar
  const r = await fetch('/api/public/orders/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
    body: JSON.stringify(body)
  });

  if (r.ok) {
    const order = await r.json();
    // limpiar carrito
    cart = [];
    saveCart();

    // mostrar confirmaciÃ³n con el pedido real creado
    out.innerHTML = `
      <div class="alert alert-success">
        <h5 class="mb-2">ðŸŽ‰ Â¡Pedido enviado!</h5>
        <p class="mb-1">NÂ° de pedido: <strong>#${order.id}</strong></p>
        <p class="mb-2">Estado: <span class="badge bg-secondary">${order.status}</span></p>
        <div class="mt-2">
          <strong>Detalle:</strong>
          <ul class="mb-2">
            ${(order.items||[]).map(i => `<li>${i.qty}Ã— ${i.product_name} â€” ${money(i.subtotal)}</li>`).join('')}
          </ul>
          <div class="fw-bold">Total: ${money(order.total_price)}</div>
        </div>
      </div>
    `;

    // Opcional: deshabilitar el botÃ³n para evitar reenvÃ­os
    document.getElementById('btn-submit').disabled = true;
  } else {
    const err = await r.json().catch(()=>({detail:'Error'}));
    out.innerHTML = `<pre class="alert alert-danger">${JSON.stringify(err, null, 2)}</pre>`;
  }
});
</script>
{% endblock %}