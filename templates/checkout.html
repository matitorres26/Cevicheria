{% extends "base.html" %}
{% block title %}Tu pedido{% endblock %}
{% block content %}

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #f9fafb;
  color: #333;
}

/* ===== CONTENEDOR ===== */
.pedido-container {
  max-width: 900px;
  margin: 2rem auto;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 2rem;
  transition: all 0.2s ease;
}

/* ===== T√çTULO ===== */
.pedido-container h1 {
  text-align: center;
  font-weight: 600;
  color: #007b83;
  margin-bottom: 1.5rem;
}

/* ===== TABLA ===== */
.table {
  border-collapse: separate;
  border-spacing: 0 8px;
}
.table thead th {
  background-color: #007b83;
  color: #fff;
  border: none;
  font-weight: 500;
}
.table tbody tr {
  background: #f6f8f9;
  border-radius: 10px;
}
.table td, .table th {
  padding: 12px;
  vertical-align: middle;
}
.table .btn {
  border-radius: 10px;
}

/* ===== FORMULARIO ===== */
form label {
  font-weight: 500;
  margin-bottom: 0.3rem;
}
form input, form select {
  border-radius: 12px;
  border: 1px solid #ddd;
  padding: 10px 14px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
form input:focus, form select:focus {
  border-color: #007b83;
  box-shadow: 0 0 0 3px rgba(0,123,131,0.2);
  outline: none;
}

/* ===== BOTONES ===== */
.btn {
  border-radius: 12px;
  font-weight: 500;
  transition: all 0.2s ease;
}
.btn-success {
  background-color: #00b894;
  border: none;
}
.btn-success:hover {
  background-color: #009e7a;
}
.btn-outline-danger {
  border-color: #ff7675;
  color: #ff7675;
}
.btn-outline-danger:hover {
  background-color: #ff7675;
  color: #fff;
}

/* ===== ALERTAS ===== */
.alert {
  border-radius: 10px;
  padding: 1rem;
  font-size: 0.95rem;
}
.alert-success {
  background-color: #e9f8f1;
  color: #1e7e34;
  border: 1px solid #b6e4c7;
}
.alert-warning {
  background-color: #fff8e1;
  border: 1px solid #ffe082;
  color: #8d6e63;
}
.alert-danger {
  background-color: #fdecea;
  border: 1px solid #f5c6cb;
  color: #a94442;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .pedido-container {
    padding: 1.5rem;
  }
  table {
    font-size: 0.9rem;
  }
  .btn {
    font-size: 0.9rem;
  }
}
</style>

<div class="pedido-container">
  <h1>Tu pedido ü¶û</h1>

  <!-- Carrito -->
  <div id="cart" class="mb-4"></div>
  <hr class="my-3">

  <!-- Formulario -->
  <form id="f" class="card card-body">
    {% csrf_token %}
    <div class="row">
      <div class="col-md-6 mb-3">
        <label>Nombre completo</label>
        <input class="form-control" name="name" required placeholder="Ej: Juan P√©rez">
      </div>
      <div class="col-md-6 mb-3">
        <label>Tel√©fono</label>
        <input class="form-control" name="phone" placeholder="+56 9 1234 5678">
      </div>
    </div>
    <div class="mb-3">
      <label>Direcci√≥n de entrega</label>
      <input class="form-control" name="address" placeholder="Ej: Av. Costanera 123, Vi√±a del Mar">
    </div>
    <div class="mb-3">
      <label>Correo electr√≥nico</label>
      <input type="email" class="form-control" name="email" placeholder="Ej: cliente@email.com">
    </div>
    <div class="mb-4">
      <label>M√©todo de pago</label>
      <select class="form-select" name="payment_method">
        <option value="CASH">Pagar en local / Efectivo</option>
        <option disabled value="WEBPAY">Webpay (pr√≥ximamente)</option>
        <option disabled value="MERCADOPAGO">MercadoPago (pr√≥ximamente)</option>
      </select>
    </div>

    <div class="d-flex gap-3 justify-content-center">
      <button class="btn btn-success px-4" id="btn-submit" type="submit">ü¶ê Enviar pedido</button>
      <button class="btn btn-outline-danger px-4" id="btn-clear" type="button">üß∫ Vaciar carrito</button>
    </div>

    <div id="msg" class="mt-4"></div>
  </form>
</div>

<script>
// --- helpers ---
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); }
function money(n){ return '$' + Number(n || 0).toFixed(2); }

// --- render carrito ---
function renderCart(){
  const wrap = document.getElementById('cart');
  if(!cart.length){
    wrap.innerHTML = '<div class="alert alert-warning text-center">Tu carrito est√° vac√≠o. Agrega productos desde el <a href="/menu/">men√∫</a>.</div>';
    document.getElementById('btn-submit').disabled = true;
    return;
  }
  document.getElementById('btn-submit').disabled = false;

  let total = 0;
  const rows = cart.map((item, idx) => {
    const subtotal = item.qty * item.unit_price;
    item.subtotal = subtotal; total += subtotal;
    return `
      <tr>
        <td>${item.product_name}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-secondary" data-act="dec" data-idx="${idx}">‚àí</button>
          <span class="mx-2">${item.qty}</span>
          <button class="btn btn-sm btn-outline-secondary" data-act="inc" data-idx="${idx}">+</button>
        </td>
        <td class="text-end">${money(item.unit_price)}</td>
        <td class="text-end fw-semibold">${money(subtotal)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" data-act="del" data-idx="${idx}">Eliminar</button>
        </td>
      </tr>`;
  }).join('');

  wrap.innerHTML = `
    <div class="table-responsive">
      <table class="table align-middle">
        <thead><tr>
          <th>Producto</th>
          <th style="width:160px">Cantidad</th>
          <th class="text-end">Precio</th>
          <th class="text-end">Subtotal</th>
          <th class="text-end">Acci√≥n</th>
        </tr></thead>
        <tbody>${rows}</tbody>
        <tfoot><tr>
          <th colspan="3" class="text-end">Total:</th>
          <th class="text-end h5">${money(total)}</th>
          <th></th>
        </tr></tfoot>
      </table>
    </div>`;
  
  wrap.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click',e=>{
      const i = Number(e.currentTarget.dataset.idx);
      const act = e.currentTarget.dataset.act;
      if(act==='inc') cart[i].qty++;
      if(act==='dec') cart[i].qty = Math.max(1, cart[i].qty-1);
      if(act==='del') cart.splice(i,1);
      saveCart(); renderCart();
    });
  });
}
renderCart();

// --- limpiar carrito ---
document.getElementById('btn-clear').addEventListener('click',()=>{
  if(cart.length && confirm('¬øVaciar carrito?')){
    cart = []; saveCart(); renderCart();
  }
});

// --- enviar pedido ---
document.getElementById('f').addEventListener('submit',async e=>{
  e.preventDefault();
  const msg = document.getElementById('msg');
  if(!cart.length){ msg.innerHTML='<div class="alert alert-warning">Tu carrito est√° vac√≠o.</div>'; return; }

  const fd = new FormData(e.target);
  const body = {
    name: fd.get('name'), phone: fd.get('phone') || '',
    address: fd.get('address') || '', email: fd.get('email') || '',
    payment_method: fd.get('payment_method'),
    items: cart.map(i=>({product_name:i.product_name, qty:i.qty, unit_price:i.unit_price, subtotal:i.subtotal}))
  };

  const r = await fetch('/api/public/orders/',{
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':fd.get('csrfmiddlewaretoken')},
    body:JSON.stringify(body)
  });

  if(r.ok){
    const order = await r.json();
    cart = []; saveCart();
    msg.innerHTML = `
      <div class="alert alert-success text-center">
        <h5>üéâ ¬°Pedido enviado con √©xito!</h5>
        <p>N¬∞ de pedido: <strong>#${order.id}</strong></p>
        <p>Estado: <span class="badge bg-secondary">${order.status}</span></p>
        <div class="mt-2 fw-bold">Total: ${money(order.total_price)}</div>
      </div>`;
    document.getElementById('btn-submit').disabled = true;
  } else {
    msg.innerHTML = `<div class="alert alert-danger">Error al enviar el pedido</div>`;
  }
});
</script>

{% endblock %}