{% extends "base.html" %}
{% block title %}Pedidos{% endblock %}
{% block content %}
<h1 class="h3 mb-3">Pedidos (hoy)</h1>
<div id="orders" class="row g-3"></div>

<script>
async function loadOrders() {
  const r = await fetch('/api/orders/');
  const data = await r.json();
  const wrap = document.getElementById('orders');
  wrap.innerHTML = (data || []).map(o => `
    <div class="col-12 col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-1">Orden #${o.id}</h5>
            <span class="badge bg-secondary">${o.status}</span>
          </div>
          <p class="text-muted mb-2">Cliente: ${o.customer}</p>
          <ul class="mb-2">
            ${(o.items || []).map(i => `
              <li>${i.qty}√ó ${i.product_name} ‚Äî $${i.subtotal}</li>
            `).join('')}
          </ul>
          <strong>Total: $${o.total_price}</strong>
        </div>
      </div>
    </div>
  `).join('');
}

loadOrders();

// ---------- WebSocket tiempo real ----------
const wsScheme = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${wsScheme}://${location.host}/ws/orders/`);

ws.onopen = () => console.log("üîå WebSocket conectado");
ws.onmessage = (e) => {
  try {
    const data = JSON.parse(e.data);
    if (data.type === "new_order") {
      console.log("üì¶ Nuevo pedido recibido:", data.order_id);
      loadOrders(); // recarga la lista autom√°ticamente
    }
  } catch (err) {
    console.error("Error procesando mensaje WS:", err);
  }
};
ws.onclose = () => console.warn("‚ö†Ô∏è WebSocket desconectado");
</script>
{% endblock %}